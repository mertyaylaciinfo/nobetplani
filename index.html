<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akıllı Nöbet Çizelgesi (Pro)</title>
    <!-- React ve ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Html2Canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* Ekran Stilleri */
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Özel Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* Modal Animasyonları */
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .modal-animate {
            animation: scaleIn 0.2s ease-out forwards;
        }

        /* Kura Animasyonları */
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(5%); }
        }
        .animate-bounce-slow { animation: bounce-slow 2s infinite; }

        /* Yazdırma Ayarları */
        @media print {
            body { 
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important; 
                background-color: white !important; 
                margin: 0 !important;
                padding: 0 !important;
            }
            .print\:hidden { display: none !important; }
            .no-break { break-inside: avoid; }
            
            @page { margin: 0; size: auto; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- FIREBASE SETUP -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE KONFIGURASYONU ---
        const myFirebaseConfig = {
            apiKey: "AIzaSyDkYb--zciZkccOC3fD_ym5LQmxoTEL7ZE",
            authDomain: "akilli-nobet-cizelgesi.firebaseapp.com",
            projectId: "akilli-nobet-cizelgesi",
            storageBucket: "akilli-nobet-cizelgesi.firebasestorage.app",
            messagingSenderId: "168778872634",
            appId: "1:168778872634:web:9c42fa2c2b54d1c8a30203",
            measurementId: "G-JY572HCLHR"
        };

        let firebaseConfig;
        let appId;

        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : 'demo-app-id';
            window.isCustomConfig = false;
        } else if (myFirebaseConfig.apiKey && myFirebaseConfig.apiKey !== "BURAYA_API_KEY_YAZILACAK") {
            firebaseConfig = myFirebaseConfig;
            appId = 'nobet-sistemi-v1';
            window.isCustomConfig = true;
        } else {
            firebaseConfig = null;
            appId = 'nobet-sistemi-v1';
            window.isCustomConfig = false;
        }

        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                window.db = db;
                window.auth = auth;
                window.appId = appId;
                window.doc = doc;
                window.setDoc = setDoc;
                window.onSnapshot = onSnapshot;
                window.collection = collection;
                window.signInAnonymously = signInAnonymously;
                window.signInWithCustomToken = signInWithCustomToken;
                window.onAuthStateChanged = onAuthStateChanged;
                window.isFirebaseAvailable = true;
            } catch (e) {
                console.error("Firebase Hatası:", e);
                window.isFirebaseAvailable = false;
            }
        } else {
            window.isFirebaseAvailable = false;
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icons = {
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            Printer: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            UserPlus: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>,
            ChevronLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
            ChevronRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            BrainCircuit: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/><path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"/><path d="M3.477 10.896a4 4 0 0 1 .585-.396"/><path d="M19.938 10.5a4 4 0 0 1 .585.396"/><path d="M6 18a4 4 0 0 1-1.97-3.284"/><path d="M17.97 14.716A4 4 0 0 1 16 18"/></svg>,
            LayoutList: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>,
            Users: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 12"/></svg>,
            Sparkles: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275Z"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            FileSpreadsheet: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>,
            FileImage: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><circle cx="10" cy="10" r="2"/><path d="m20 17-1.296-1.296a2.41 2.41 0 0 0-3.408 0L9 22"/></svg>,
            Activity: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Unlock: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>,
            LogIn: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>,
            LogOut: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="3" y1="12" y2="12"/></svg>,
            UserCheck: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></svg>,
            Dices: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="12" height="12" x="2" y="10" rx="2" ry="2"/><path d="m17.92 14 3.5-3.5a2.24 2.24 0 0 0 0-3l-5-4.92a2.24 2.24 0 0 0-3 0L10 6"/><path d="M6 18h.01"/><path d="M10 14h.01"/><path d="M15 6h.01"/><path d="M18 9h.01"/></svg>,
            MessageSquare: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            Cloud: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17.5 19c0-1.7-1.3-3-3-3h-1.1c-.1-2.9-2.4-5.2-5.3-5.3h-.1C5.3 10.7 3 13 3 15.9c0 2.9 2.3 5.1 5.1 5.1h9.4c1.7 0 3-1.3 3-3z"/></svg>,
            Video: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></svg>,
            StopCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><rect width="6" height="6" x="9" y="9"/></svg>,
            Check: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Share: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"/><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"/></svg>,
            AlertTriangle: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>
        };

        // --- MODAL COMPONENT ---
        const Modal = ({ isOpen, onClose, title, children, type = 'info' }) => {
            if (!isOpen) return null;
            return (
                <div onClick={onClose} className="fixed inset-0 z-[999] flex items-center justify-center bg-black/50 backdrop-blur-sm transition-opacity cursor-pointer">
                    <div onClick={(e) => e.stopPropagation()} className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 m-4 modal-animate relative border border-gray-100 cursor-default">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><Icons.X size={20} /></button>
                        <div className="mb-4">
                            {type === 'error' && <div className="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100"><Icons.AlertTriangle className="text-red-600" /></div>}
                            {type === 'warning' && <div className="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-orange-100"><Icons.AlertTriangle className="text-orange-600" /></div>}
                            {type === 'success' && <div className="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100"><Icons.Check className="text-green-600" /></div>}
                            {type === 'info' && <div className="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-blue-100"><Icons.Lock className="text-blue-600" /></div>}
                        </div>
                        <h3 className="text-xl font-bold text-center text-gray-900 mb-2">{title}</h3>
                        <div className="mt-2 text-center text-gray-600">{children}</div>
                    </div>
                </div>
            );
        };

        function NobetCizelgesi() {
            const [activeTab, setActiveTab] = useState('calendar'); 
            const [currentDate, setCurrentDate] = useState(new Date());
            const [printMenuOpen, setPrintMenuOpen] = useState(false);
            
            // FIREBASE & AUTH STATES
            const [userRole, setUserRole] = useState('guest'); 
            const [loggedInDoctorId, setLoggedInDoctorId] = useState(null);
            const [isFirebaseConnected, setIsFirebaseConnected] = useState(false);
            const [firebaseUser, setFirebaseUser] = useState(null);
            
            // Veri yazma kilidi
            const isWriting = useRef(false);

            // KURA SİSTEMİ STATE'LERİ
            const [lotteryTitle, setLotteryTitle] = useState('Nöbet Kurası');
            const [lotteryParticipants, setLotteryParticipants] = useState([]); 
            const [lotteryWinnerCount, setLotteryWinnerCount] = useState(1);
            const [lotteryResults, setLotteryResults] = useState(null);
            const [isDrawing, setIsDrawing] = useState(false);

            // MODAL STATES
            const [modalConfig, setModalConfig] = useState({ isOpen: false, title: '', content: null, type: 'info', onConfirm: null });
            
            // SCREEN RECORDING
            const [isRecording, setIsRecording] = useState(false);
            const [recordedBlob, setRecordedBlob] = useState(null); // Paylaşım için Blob
            const mediaRecorderRef = useRef(null);
            const recordedChunks = useRef([]);

            const tableRef = useRef(null);
            const blueCodeRef = useRef(null);
            
            // --- VERİ STATE'LERİ ---
            const defaultDoctors = [
                { id: 1, name: 'Dr. Ahmet Yılmaz', tc: '14767899180' },
                { id: 2, name: 'Dr. Ayşe Demir', tc: '22222222222' },
                { id: 3, name: 'Dr. Mehmet Kaya', tc: '33333333333' },
                { id: 4, name: 'Dr. Fatma Çelik', tc: '44444444444' },
                { id: 5, name: 'Dr. Mustafa Şahin', tc: '55555555555' },
                { id: 6, name: 'Dr. Zeynep Yıldız', tc: '66666666666' },
                { id: 7, name: 'Dr. Ali Öztürk', tc: '77777777777' },
                { id: 8, name: 'Dr. Esra Aydın', tc: '88888888888' },
                { id: 9, name: 'Dr. Burak Arslan', tc: '99999999999' },
                { id: 10, name: 'Dr. Elif Koç', tc: '10101010101' },
            ];

            const [doctors, setDoctors] = useState(defaultDoctors);
            const [shifts, setShifts] = useState({});
            const [doctorRequests, setDoctorRequests] = useState({});
            const [doctorTargets, setDoctorTargets] = useState({});
            const [doctorGaps, setDoctorGaps] = useState({});
            const [dailyTargets, setDailyTargets] = useState({}); 
            const [pairedGroups, setPairedGroups] = useState([]); 
            const [blueCodeList, setBlueCodeList] = useState([]);

            const shiftTypes = ['24', '16', '8', '5', 'Yİ', 'İİ', 'R', 'X']; 
            const [selectedShiftType, setSelectedShiftType] = useState('24');
            const monthNames = ["OCAK", "ŞUBAT", "MART", "NİSAN", "MAYIS", "HAZİRAN", "TEMMUZ", "AĞUSTOS", "EYLÜL", "EKİM", "KASIM", "ARALIK"];

            // --- FIREBASE BAĞLANTISI ---
            useEffect(() => {
                if (window.isFirebaseAvailable) {
                    const initAuth = async () => {
                        if (window.isCustomConfig) {
                            try { await window.signInAnonymously(window.auth); } catch (err) { console.error(err); }
                            return;
                        }
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try { await window.signInWithCustomToken(window.auth, __initial_auth_token); } 
                            catch (e) { await window.signInAnonymously(window.auth); }
                        } else {
                            await window.signInAnonymously(window.auth);
                        }
                    };
                    initAuth();
                    const unsubscribe = window.onAuthStateChanged(window.auth, (user) => {
                        setFirebaseUser(user);
                        setIsFirebaseConnected(!!user);
                    });
                    return () => unsubscribe();
                }
            }, []);

            // --- USER ROLE CHANGE EFFECT ---
            useEffect(() => {
                if (userRole === 'doctor') setSelectedShiftType('X');
                else if (userRole === 'admin') setSelectedShiftType('24');
            }, [userRole]);

            // --- YARDIMCI: DÖNEM ID OLUŞTURUCU ---
            const getPeriodDocId = (date) => {
                return `nobet_data_${date.getFullYear()}_${date.getMonth()}`;
            };

            // --- VERİ OKUMA (AYLIK) ---
            useEffect(() => {
                if (!firebaseUser || !window.isFirebaseAvailable) return;

                const docId = getPeriodDocId(currentDate);
                const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'nobet_system', docId);
                
                const unsubscribe = window.onSnapshot(docRef, (snapshot) => {
                    if (isWriting.current) return;

                    if (snapshot.exists()) {
                        const data = snapshot.data();
                        if (data.doctors) setDoctors(data.doctors);
                        if (data.shifts) setShifts(data.shifts);
                        if (data.requests) setDoctorRequests(data.requests);
                        if (data.targets) setDoctorTargets(data.targets || {});
                        if (data.gaps) setDoctorGaps(data.gaps || {});
                        if (data.dailyTargets) setDailyTargets(data.dailyTargets || {});
                        if (data.pairedGroups) setPairedGroups(data.pairedGroups || []);
                    } else {
                        // Yeni ay için temizlik
                        setShifts({});
                        setDoctorRequests({});
                        setDoctorTargets({});
                        setDoctorGaps({});
                        setDailyTargets({});
                        setPairedGroups([]);
                    }
                }, (error) => {
                    console.error("Veri okuma hatası:", error);
                });

                return () => unsubscribe();
            }, [firebaseUser, currentDate]);

            // --- GÜVENLİ VERİ YAZMA (AYLIK) ---
            const saveToCloud = async (overrideData = {}) => {
                if (!firebaseUser || !window.isFirebaseAvailable) return;

                isWriting.current = true;

                const docId = getPeriodDocId(currentDate);

                const dataToSave = {
                    doctors, 
                    shifts,
                    requests: doctorRequests,
                    targets: doctorTargets,
                    gaps: doctorGaps,
                    dailyTargets,
                    pairedGroups,
                    updatedAt: new Date().toISOString(),
                    ...overrideData
                };

                const docRef = window.doc(window.db, 'artifacts', window.appId, 'public', 'data', 'nobet_system', docId);
                try {
                    await window.setDoc(docRef, dataToSave, { merge: true });
                } catch (err) {
                    console.error("Kaydetme hatası:", err);
                    showModal("Hata", "Veriler buluta kaydedilemedi.", "error");
                } finally {
                    setTimeout(() => { isWriting.current = false; }, 500);
                }
            };

            const getDaysInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const days = new Date(year, month + 1, 0).getDate();
                return Array.from({ length: days }, (_, i) => i + 1);
            };
            const days = getDaysInMonth(currentDate);

            useEffect(() => {
                if (activeTab === 'lottery' && lotteryParticipants.length === 0) {
                    setLotteryParticipants(doctors.map(d => d.id));
                }
            }, [activeTab]);

            useEffect(() => {
                if (Object.keys(dailyTargets).length === 0) {
                    const initialDailyTargets = {};
                    days.forEach(day => { initialDailyTargets[day] = 2; });
                    setDailyTargets(initialDailyTargets);
                }
            }, [currentDate.getMonth()]);

            useEffect(() => {
                const newList = days.map(day => {
                    const dateObj = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                    const dayOfWeek = dateObj.getDay();
                    const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                    
                    const dateStr = `${day}.${currentDate.getMonth() + 1}.${currentDate.getFullYear()}`;
                    const dayName = dateObj.toLocaleDateString('tr-TR', { weekday: 'long' });

                    const watchers = doctors.filter(doc => shifts[`${doc.id}-${day}`] === '24');
                    
                    let selectedWatcherName = "";
                    if (watchers.length > 0) {
                        const index = (day + watchers.length) % watchers.length; 
                        selectedWatcherName = watchers[index].name;
                    }
                    return { date: dateStr, dayName: dayName, doctor: selectedWatcherName, isWeekend };
                });
                setBlueCodeList(newList);
            }, [shifts, currentDate, doctors]);

            const checkDayStatus = (day) => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth(); 
                const dateObj = new Date(year, month, day);
                const dayOfWeek = dateObj.getDay();
                const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
                let isHoliday = false;
                const staticHolidays = ["1-0", "23-3", "1-4", "19-4", "15-6", "30-7", "29-9"];
                if (staticHolidays.includes(`${day}-${month}`)) isHoliday = true;
                if (year === 2025 && ((month === 2 && day >= 30) || (month === 3 && day <= 1) || (month === 5 && day >= 6 && day <= 9))) isHoliday = true;
                return { isWeekend, isHoliday, isOff: isWeekend || isHoliday };
            };

            const injectPrintStyles = () => {
                const existingStyle = document.getElementById('dynamic-print-style');
                if (existingStyle) existingStyle.remove();
                const style = document.createElement('style');
                style.id = 'dynamic-print-style';
                
                if (activeTab === 'bluecode') {
                    style.innerHTML = `
                        @media print { 
                            @page { size: A4; margin: 0; }
                            body { margin: 0; padding: 0; background: white; }
                            #root { display: none; }
                            .blue-code-wrapper { 
                                display: flex !important; 
                                justify-content: center !important; 
                                align-items: center !important; 
                                height: 100vh !important; 
                                width: 100vw !important;
                                margin: 0 !important;
                                padding: 0 !important;
                                position: absolute;
                                top: 0;
                                left: 0;
                            }
                            .blue-code-container { 
                                width: 190mm !important; 
                                min-height: 280mm !important; 
                                box-shadow: none !important; 
                                border: none !important;
                            }
                        }
                    `;
                } else {
                    style.innerHTML = `
                        @media print { 
                            @page { size: landscape; margin: 5mm; }
                            body { zoom: 0.65; }
                        }
                    `;
                }
                document.head.appendChild(style);
            };

            useEffect(() => { injectPrintStyles(); }, [activeTab]);

            const getStandardMonthlyHours = () => {
                let workDays = 0;
                days.forEach(day => { const status = checkDayStatus(day); if (!status.isOff) workDays++; });
                return workDays * 8;
            };

            const calculateDoctorStats = (doctorId) => {
                let count24 = 0; let totalWorkedHours = 0; let leaveDeduction = 0;
                days.forEach(day => {
                    const shift = shifts[`${doctorId}-${day}`];
                    if (shift === '24') { count24++; totalWorkedHours += 24; }
                    else if (shift === '16') totalWorkedHours += 16;
                    else if (shift === '8') totalWorkedHours += 8;
                    else if (shift === '5') totalWorkedHours += 5;
                    if (['Yİ', 'İİ', 'R'].includes(shift)) { const status = checkDayStatus(day); if (!status.isOff) leaveDeduction += 8; }
                });
                const standardHours = getStandardMonthlyHours();
                const personalTarget = standardHours - leaveDeduction;
                const extraHours = totalWorkedHours - personalTarget;
                return { count24, totalWorkedHours, personalTarget, extraHours };
            };

            const getDailyDoctorCount = (day) => {
                let count = 0;
                doctors.forEach(doc => { if (shifts[`${doc.id}-${day}`] === '24') count++; });
                return count;
            };

            const exportToPDF = () => { injectPrintStyles(); setTimeout(() => { window.print(); setPrintMenuOpen(false); }, 100); };
            const exportToJPEG = (targetRef) => {
                setPrintMenuOpen(false);
                const element = targetRef === 'bluecode' ? blueCodeRef.current : tableRef.current;
                if (element) {
                    html2canvas(element).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `Nobet_${activeTab === 'bluecode' ? 'MaviKod' : 'Cizelgesi'}_${monthNames[currentDate.getMonth()]}.jpg`;
                        link.href = canvas.toDataURL('image/jpeg');
                        link.click();
                    });
                }
            };
            const exportToExcel = (type) => {
                setPrintMenuOpen(false);
                if (type === 'bluecode') {
                    const header = ["TARİH", "GÜN", "NÖBETÇİ"];
                    const data = blueCodeList.map(item => [item.date, item.dayName, item.doctor]);
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.aoa_to_sheet([header, ...data]);
                    ws['!cols'] = [{wch: 15}, {wch: 15}, {wch: 30}];
                    XLSX.utils.book_append_sheet(wb, ws, "Mavi Kod Listesi");
                    XLSX.writeFile(wb, `Mavi_Kod_${monthNames[currentDate.getMonth()]}.xlsx`);
                    return;
                }
                const header = ["Hekim Adı", ...days, "Toplam Nöbet", "Toplam Saat", "Aylık Mesai", "Ek Mesai"];
                const data = [];
                doctors.forEach(doc => {
                    let row = [doc.name];
                    days.forEach(day => { row.push(shifts[`${doc.id}-${day}`] || ""); });
                    const stats = calculateDoctorStats(doc.id);
                    row.push(stats.count24, stats.totalWorkedHours, stats.personalTarget, stats.extraHours);
                    data.push(row);
                });
                let totalRow = ["Günlük Nöbetçi Sayısı"];
                days.forEach(day => totalRow.push(getDailyDoctorCount(day)));
                data.push(totalRow);
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet([header, ...data]);
                const wscols = [{wch: 20}]; 
                for(let i=0; i<days.length; i++) wscols.push({wch: 3}); 
                ws['!cols'] = wscols;
                XLSX.utils.book_append_sheet(wb, ws, "Nöbet Listesi");
                XLSX.writeFile(wb, `Nobet_Cizelgesi_${monthNames[currentDate.getMonth()]}.xlsx`);
            };

            const startRecording = async () => {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
                    showModal("Hata", "Tarayıcınız ekran kaydını desteklemiyor.", "error");
                    return;
                }
                try {
                    const stream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: "always" }, audio: false });
                    mediaRecorderRef.current = new MediaRecorder(stream, { mimeType: "video/webm" });
                    
                    mediaRecorderRef.current.ondataavailable = (event) => {
                        if (event.data.size > 0) recordedChunks.current.push(event.data);
                    };
                    
                    mediaRecorderRef.current.onstop = () => {
                        const blob = new Blob(recordedChunks.current, { type: "video/webm" });
                        recordedChunks.current = [];
                        setRecordedBlob(blob);
                        setIsRecording(false);
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    stream.getVideoTracks()[0].onended = () => { if (isRecording) stopRecording(); };
                    
                    mediaRecorderRef.current.start();
                    setIsRecording(true);
                    setRecordedBlob(null);
                } catch (err) {
                    console.error("Ekran kaydı hatası:", err);
                    showModal("Hata", "Ekran kaydı başlatılamadı.", "error");
                }
            };
            
            const stopRecording = () => {
                if(mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
                    mediaRecorderRef.current.stop();
                }
            };

            const shareVideoOnWhatsApp = async () => {
                if (!recordedBlob) return;

                const fileName = `kura-cekimi-${new Date().getTime()}.webm`;
                const file = new File([recordedBlob], fileName, { type: "video/webm" });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: 'Kura Çekimi',
                            text: 'Nöbet kura çekimi sonuçları ektedir.'
                        });
                    } catch (err) {
                        console.error("Paylaşım hatası:", err);
                        if (err.name !== 'AbortError') {
                             showModal("Hata", "Mobil paylaşım başarısız oldu. Video indiriliyor...", "warning");
                             const url = URL.createObjectURL(recordedBlob);
                             const a = document.createElement("a");
                             document.body.appendChild(a);
                             a.style = "display: none";
                             a.href = url;
                             a.download = fileName;
                             a.click();
                             window.URL.revokeObjectURL(url);
                        }
                    }
                } else {
                    const url = URL.createObjectURL(recordedBlob);
                    const a = document.createElement("a");
                    document.body.appendChild(a);
                    a.style = "display: none";
                    a.href = url;
                    a.download = fileName;
                    a.click();
                    window.URL.revokeObjectURL(url);

                    showModal("Video İndirildi", 
                        <div className="flex flex-col gap-4 items-center">
                            <p>Video başarıyla cihazınıza indirildi.</p>
                            <p className="text-sm text-gray-500">WhatsApp Web'i açın ve indirdiğiniz dosyayı sohbete sürükleyin.</p>
                            <a 
                                href="https://web.whatsapp.com" 
                                target="_blank" 
                                rel="noopener noreferrer"
                                className="bg-[#25D366] text-white px-6 py-3 rounded-full font-bold flex items-center gap-2 hover:bg-[#128C7E] transition-all shadow-lg"
                                onClick={closeModal}
                            >
                                <Icons.Share size={20} /> WhatsApp Web'i Aç
                            </a>
                        </div>, 
                    "success");
                }
            };

            const changeAllTargets = (delta) => { const newTargets = {}; const defaultTarget = Math.ceil((days.length * 2) / doctors.length); doctors.forEach(doc => { const current = doctorTargets[doc.id] !== undefined ? doctorTargets[doc.id] : defaultTarget; newTargets[doc.id] = Math.max(0, current + delta); }); setDoctorTargets(newTargets); saveToCloud({targets: newTargets}); };
            const changeAllGaps = (delta) => { const newGaps = {}; doctors.forEach(doc => { const current = doctorGaps[doc.id] !== undefined ? doctorGaps[doc.id] : 1; newGaps[doc.id] = Math.max(0, current + delta); }); setDoctorGaps(newGaps); saveToCloud({gaps: newGaps}); };
            const changeAllDailyTargets = (delta) => { const newDaily = {}; days.forEach(day => { const current = dailyTargets[day] !== undefined ? dailyTargets[day] : 2; newDaily[day] = Math.max(0, current + delta); }); setDailyTargets(newDaily); saveToCloud({dailyTargets: newDaily}); };
            const getTotalSupply = () => { let total = 0; doctors.forEach(doc => { total += doctorTargets[doc.id] !== undefined ? doctorTargets[doc.id] : Math.ceil((days.length * 2) / doctors.length); }); return total; };
            const getTotalDemand = () => { let total = 0; days.forEach(day => { total += dailyTargets[day] !== undefined ? dailyTargets[day] : 2; }); return total; };
            
            const getShiftStyle = (type) => {
                const common = "w-full h-full flex items-center justify-center rounded border shadow-sm font-bold text-xs transition-all";
                switch (type) {
                    case '24': return `${common} bg-green-100 text-green-800 border-green-200`;
                    case '16': 
                    case '8': 
                    case '5': return `${common} bg-orange-100 text-orange-800 border-orange-200`;
                    case 'Yİ': 
                    case 'İİ': 
                    case 'R': return `${common} bg-red-100 text-red-800 border-red-200`;
                    case 'X': return `${common} bg-gray-800 text-white border-gray-900`;
                    default: return `${common} bg-gray-500 text-white`;
                }
            };

            const confirmGeneration = () => {
                const totalSupply = getTotalSupply();
                const totalDemand = getTotalDemand();
                
                let message = "Mevcut nöbetler (İzinler ve İstemiyorum 'X' hariç) silinip yeniden dağıtılacak. Onaylıyor musunuz?";
                let type = 'info';

                if (Math.abs(totalSupply - totalDemand) > 5) {
                    message = `DİKKAT: Arz ve Talep arasında büyük fark var!\n\nHekimlerin Toplam Hedefi: ${totalSupply}\nGünlük İhtiyaç Toplamı: ${totalDemand}\n\nBu durum dengesiz dağılıma yol açabilir. Devam edilsin mi?`;
                    type = 'warning';
                }

                showModal("Dağıtım Onayı", 
                    <div className="flex flex-col gap-4">
                        <p className="whitespace-pre-line text-left text-sm">{message}</p>
                        <div className="flex gap-2 justify-end mt-2">
                            <button onClick={closeModal} className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium">İptal</button>
                            <button onClick={() => { closeModal(); runAlgorithm(); }} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold">Başlat</button>
                        </div>
                    </div>,
                type);
            };

            const runAlgorithm = () => {
                try {
                    const daysInMonth = days.length;
                    let newShifts = { ...shifts };
                    
                    Object.keys(newShifts).forEach(key => { if (['24', '16', '8', '5'].includes(newShifts[key])) delete newShifts[key]; });
                    
                    const targets = { ...doctorTargets };
                    const gaps = { ...doctorGaps };
                    let realTotalDemand = 0;
                    for(let d=1; d<=daysInMonth; d++) { realTotalDemand += (dailyTargets[d] !== undefined ? dailyTargets[d] : 2); }

                    doctors.forEach(doc => { 
                        if (targets[doc.id] === undefined) targets[doc.id] = Math.ceil(realTotalDemand / doctors.length); 
                        if (gaps[doc.id] === undefined) gaps[doc.id] = 1; 
                    });

                    let doctorCounts = {};
                    let doctorWeekendCounts = {};
                    let partialGroupMatches = new Array(pairedGroups.length).fill(0);

                    doctors.forEach(d => { doctorCounts[d.id] = 0; doctorWeekendCounts[d.id] = 0; });

                    const distributeForDays = (dayList, isWeekendPhase) => {
                        dayList.forEach(day => {
                            const slotsForThisDay = dailyTargets[day] !== undefined ? dailyTargets[day] : 2;
                            let finalSelection = [];

                            let pool = [...doctors].sort((a, b) => { 
                                const remainingA = targets[a.id] - doctorCounts[a.id]; 
                                const remainingB = targets[b.id] - doctorCounts[b.id]; 
                                if (isWeekendPhase) {
                                    const wA = doctorWeekendCounts[a.id];
                                    const wB = doctorWeekendCounts[b.id];
                                    if (wA !== wB) return wA - wB; 
                                }
                                if (remainingA !== remainingB) return remainingB - remainingA; 
                                return Math.random() - 0.5; 
                            });

                            pool = pool.filter(doc => {
                                const existingShift = newShifts[`${doc.id}-${day}`];
                                if (existingShift && ['Yİ', 'İİ', 'R', 'Nİ', 'X'].includes(existingShift)) return false;
                                if (newShifts[`${doc.id}-${day}`] === '24') return false;
                                const minGap = gaps[doc.id];
                                for (let gap = 1; gap <= minGap; gap++) { 
                                    if (day - gap > 0) { const prevShift = newShifts[`${doc.id}-${day - gap}`]; if (prevShift && ['24', '16', '8', '5'].includes(prevShift)) return false; }
                                    if (day + gap <= daysInMonth) { const nextShift = newShifts[`${doc.id}-${day + gap}`]; if (nextShift && ['24', '16', '8', '5'].includes(nextShift)) return false; }
                                }
                                return true;
                            });

                            while (finalSelection.length < slotsForThisDay && pool.length > 0) {
                                let bestIndex = -1;
                                for(let i=0; i<pool.length; i++) {
                                    const cand = pool[i];
                                    const candidatesNeedShifts = pool.filter(p => doctorCounts[p.id] < targets[p.id]);
                                    const slotsNeeded = slotsForThisDay - finalSelection.length;
                                    if (doctorCounts[cand.id] >= targets[cand.id] && candidatesNeedShifts.length >= slotsNeeded) continue; 
                                    const groupIndex = pairedGroups.findIndex(g => g.ids.includes(cand.id));
                                    const group = groupIndex !== -1 ? pairedGroups[groupIndex] : null;
                                    let sizeToAdd = 1;
                                    if (group) {
                                        const isStrict = group.type === 'strict';
                                        const isPartial = group.type === 'partial';
                                        const partnerIds = group.ids.filter(id => id !== cand.id);
                                        const validPartners = partnerIds.filter(pid => pool.some(p => p.id === pid) && !finalSelection.some(f => f.id === pid));
                                        if (isStrict) {
                                            const allPartnersAvailableOrSelected = partnerIds.every(pid => pool.some(p => p.id === pid) || finalSelection.some(f => f.id === pid));
                                            if (!allPartnersAvailableOrSelected) continue; 
                                            sizeToAdd = 1 + validPartners.length;
                                        } else if (isPartial) {
                                            if (partialGroupMatches[groupIndex] < 3) {
                                                if (finalSelection.length + 1 + validPartners.length <= slotsForThisDay) sizeToAdd = 1 + validPartners.length;
                                                else sizeToAdd = 1; 
                                            } else sizeToAdd = 1;
                                        }
                                    }
                                    if (finalSelection.length + sizeToAdd <= slotsForThisDay) { bestIndex = i; break; }
                                }
                                if (bestIndex === -1 && pool.length > 0) bestIndex = 0; 
                                if (bestIndex !== -1) {
                                    const pick = pool[bestIndex];
                                    const groupIndex = pairedGroups.findIndex(g => g.ids.includes(pick.id));
                                    const group = groupIndex !== -1 ? pairedGroups[groupIndex] : null;
                                    finalSelection.push(pick);
                                    pool = pool.filter(p => p.id !== pick.id); 
                                    if (group) {
                                        const partnerIds = group.ids.filter(id => id !== pick.id);
                                        const availablePartners = partnerIds.map(pid => doctors.find(d => d.id === pid)).filter(d => d && pool.some(p => p.id === d.id));
                                        if (group.type === 'strict') {
                                            availablePartners.forEach(p => { finalSelection.push(p); pool = pool.filter(x => x.id !== p.id); });
                                        } else if (group.type === 'partial') {
                                            if (partialGroupMatches[groupIndex] < 3) {
                                                if (finalSelection.length + availablePartners.length <= slotsForThisDay) {
                                                    availablePartners.forEach(p => { finalSelection.push(p); pool = pool.filter(x => x.id !== p.id); });
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                            finalSelection.forEach(doc => { 
                                newShifts[`${doc.id}-${day}`] = '24'; 
                                doctorCounts[doc.id]++; 
                                if (isWeekendPhase) doctorWeekendCounts[doc.id]++;
                            });
                            pairedGroups.forEach((group, idx) => {
                                if (group.type === 'partial') {
                                    const membersInShift = group.ids.filter(gid => finalSelection.some(f => f.id === gid));
                                    if (membersInShift.length >= 2) partialGroupMatches[idx]++;
                                }
                            });
                        });
                    };

                    const weekendDays = days.filter(d => checkDayStatus(d).isOff);
                    distributeForDays(weekendDays, true);
                    const weekDays = days.filter(d => !checkDayStatus(d).isOff);
                    distributeForDays(weekDays, false);
                    setShifts(newShifts);
                    saveToCloud({shifts: newShifts});
                    showModal("Başarılı", "Nöbetler başarıyla dağıtıldı!", "success");
                    setActiveTab('calendar');
                } catch (err) {
                    console.error("Dağıtım hatası:", err);
                    showModal("Hata", "Dağıtım sırasında bir hata oluştu: " + err.message, "error");
                }
            };

            const [selectedForGroup, setSelectedForGroup] = useState([]);
            const [groupType, setGroupType] = useState('strict'); 
            const toggleSelectForGroup = (id) => { if (selectedForGroup.includes(id)) setSelectedForGroup(prev => prev.filter(x => x !== id)); else setSelectedForGroup(prev => [...prev, id]); };
            const createGroup = () => { if (selectedForGroup.length < 2) return showModal("Hata", "En az 2 hekim seçmelisiniz.", "error"); const newGroups = [...pairedGroups, { ids: selectedForGroup, type: groupType }]; setPairedGroups(newGroups); setSelectedForGroup([]); saveToCloud({pairedGroups: newGroups}); };
            const removeGroup = (index) => { const newGroups = pairedGroups.filter((_, i) => i !== index); setPairedGroups(newGroups); saveToCloud({pairedGroups: newGroups}); };

            const showModal = (title, content, type = 'info', onConfirm = null) => {
                setModalConfig({ isOpen: true, title, content, type, onConfirm });
            };
            
            const closeModal = () => {
                setModalConfig(prev => ({ ...prev, isOpen: false }));
            };

            const handleAdminLogin = () => {
                let password = "";
                const confirmLogin = () => {
                    if (password === "Me121314") {
                        setUserRole('admin');
                        setLoggedInDoctorId(null);
                        showModal("Başarılı", "Yönetici girişi yapıldı.", "success");
                    } else {
                        showModal("Hata", "Hatalı şifre!", "error");
                    }
                };

                showModal("Yönetici Girişi", 
                    <div className="flex flex-col gap-3">
                        <input 
                            type="password" 
                            placeholder="Şifre Giriniz" 
                            className="border p-2 rounded w-full" 
                            onChange={(e) => password = e.target.value}
                            onKeyDown={(e) => e.key === 'Enter' && confirmLogin()}
                            autoFocus
                        />
                        <button onClick={confirmLogin} className="bg-blue-600 text-white p-2 rounded">Giriş Yap</button>
                    </div>, 
                'info');
            };

            const handleDoctorLogin = () => {
                let inputTc = "";
                const confirmLogin = () => {
                    const cleanTc = inputTc.trim();
                    const doctor = doctors.find(d => d.tc === cleanTc);
                    if (doctor) {
                        setUserRole('doctor');
                        setLoggedInDoctorId(doctor.id);
                        showModal("Hoşgeldiniz", `Sayın ${doctor.name}, sisteme giriş yaptınız.`, "success");
                    } else {
                        showModal("Hata", "Bu TC ile kayıtlı hekim bulunamadı.", "error");
                    }
                };

                showModal("Hekim Girişi", 
                    <div className="flex flex-col gap-3">
                        <input 
                            type="text" 
                            placeholder="TC Kimlik No Giriniz" 
                            className="border p-2 rounded w-full" 
                            onChange={(e) => inputTc = e.target.value} 
                            onKeyDown={(e) => e.key === 'Enter' && confirmLogin()}
                            autoFocus
                        />
                        <button onClick={confirmLogin} className="bg-indigo-600 text-white p-2 rounded">Giriş Yap</button>
                    </div>, 
                'info');
            };

            const handleLogout = () => { setUserRole('guest'); setLoggedInDoctorId(null); setActiveTab('calendar'); };

            const handleCellClick = (docId, day) => {
                const key = `${docId}-${day}`;
                const currentShift = shifts[key];
                
                if (userRole === 'admin') {
                    const newS = {...shifts};
                    if (newS[key] === selectedShiftType) delete newS[key]; else newS[key] = selectedShiftType;
                    setShifts(newS);
                    saveToCloud({shifts: newS});
                } else if (userRole === 'doctor' && docId === loggedInDoctorId) {
                    const adminAssigned = ['24', '16', '8', '5', 'İİ', 'Nİ'];
                    if (currentShift && adminAssigned.includes(currentShift)) {
                        showModal("Uyarı", "Yöneticinin atadığı nöbeti değiştiremezsiniz.", "error");
                        return;
                    }

                    const newS = {...shifts};
                    // Seçilen türü kullan
                    if (newS[key] === selectedShiftType) {
                        delete newS[key]; // Aynıysa sil (toggle)
                    } else {
                        newS[key] = selectedShiftType; // Farklıysa ata
                    }
                    
                    setShifts(newS);
                    saveToCloud({shifts: newS});
                }
            };

            const toggleLotteryParticipant = (id) => { if (lotteryParticipants.includes(id)) setLotteryParticipants(prev => prev.filter(p => p !== id)); else setLotteryParticipants(prev => [...prev, id]); };
            const handleLotteryDraw = () => {
                if (lotteryParticipants.length === 0) return showModal("Hata", "Lütfen en az bir kişi seçin.", "error");
                if (lotteryWinnerCount > lotteryParticipants.length) return showModal("Hata", "Seçilecek kişi sayısı katılımcı sayısından fazla olamaz.", "error");
                setIsDrawing(true); setLotteryResults(null);
                setTimeout(() => {
                    const shuffled = [...lotteryParticipants].sort(() => 0.5 - Math.random());
                    const selectedIds = shuffled.slice(0, lotteryWinnerCount);
                    const winners = selectedIds.map(id => doctors.find(d => d.id === id));
                    setLotteryResults(winners); setIsDrawing(false);
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                }, 3000);
            };

            return (
                <div className="min-h-screen bg-gray-50 font-sans text-sm pb-10">
                    <Modal isOpen={modalConfig.isOpen} onClose={closeModal} title={modalConfig.title} type={modalConfig.type}>
                        {modalConfig.content}
                    </Modal>

                    <div className="bg-white shadow-sm border-b sticky top-0 z-50 print:hidden">
                        <div className="max-w-7xl mx-auto px-4 py-3">
                            <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                <div className="flex items-center gap-3">
                                    <div className="p-2 bg-blue-600 text-white rounded-lg"><Icons.Calendar /></div>
                                    <div>
                                        <h1 className="text-xl font-bold text-gray-800">Akıllı Nöbet Çizelgesi</h1>
                                        <div className="flex items-center gap-2 text-xs text-gray-500">
                                            {isFirebaseConnected ? (
                                                <span className="text-green-600 flex items-center gap-1"><Icons.Cloud size={12}/> Online</span>
                                            ) : (
                                                <span className="text-gray-400 flex items-center gap-1"><Icons.Cloud size={12}/> Offline</span>
                                            )}
                                            <span className="text-gray-300">|</span>
                                            {userRole === 'admin' && <span className="text-green-600 flex items-center gap-1"><Icons.Unlock size={12}/> Yönetici</span>}
                                            {userRole === 'doctor' && <span className="text-blue-600 flex items-center gap-1"><Icons.UserCheck size={12}/> Hekim: {doctors.find(d => d.id === loggedInDoctorId)?.name}</span>}
                                            {userRole === 'guest' && <span className="text-orange-500 flex items-center gap-1"><Icons.Lock size={12}/> Misafir</span>}
                                        </div>
                                    </div>
                                </div>
                                <div className="flex bg-gray-100 p-1 rounded-lg items-center">
                                    <button onClick={() => setActiveTab('calendar')} className={`flex items-center gap-2 px-4 py-2 rounded-md transition-all ${activeTab === 'calendar' ? 'bg-white shadow text-blue-600 font-bold' : 'text-gray-500 hover:text-gray-700'}`}><Icons.LayoutList /> Çizelge</button>
                                    {userRole === 'admin' && (
                                        <>
                                            <button onClick={() => setActiveTab('generator')} className={`flex items-center gap-2 px-4 py-2 rounded-md transition-all ${activeTab === 'generator' ? 'bg-white shadow text-purple-600 font-bold' : 'text-gray-500 hover:text-gray-700'}`}><Icons.BrainCircuit /> Otomatik Dağıtıcı</button>
                                            <button onClick={() => setActiveTab('lottery')} className={`flex items-center gap-2 px-4 py-2 rounded-md transition-all ${activeTab === 'lottery' ? 'bg-white shadow text-pink-600 font-bold' : 'text-gray-500 hover:text-gray-700'}`}><Icons.Dices /> Kura Çek</button>
                                        </>
                                    )}
                                    {/* Sadece Admin Mavi Kod görebilir */}
                                    {userRole === 'admin' && (
                                        <button onClick={() => setActiveTab('bluecode')} className={`flex items-center gap-2 px-4 py-2 rounded-md transition-all ${activeTab === 'bluecode' ? 'bg-white shadow text-red-600 font-bold' : 'text-gray-500 hover:text-gray-700'}`}><Icons.Activity /> Mavi Kod</button>
                                    )}
                                </div>
                                <div className="flex gap-2">
                                    {userRole === 'guest' ? (
                                        <>
                                            <button onClick={handleDoctorLogin} className="flex items-center gap-2 px-3 py-1.5 rounded-lg font-medium text-xs bg-indigo-50 text-indigo-600 hover:bg-indigo-100 transition-all">
                                                <Icons.UserCheck /> Hekim Girişi
                                            </button>
                                            <button onClick={handleAdminLogin} className="flex items-center gap-2 px-3 py-1.5 rounded-lg font-medium text-xs bg-blue-50 text-blue-600 hover:bg-blue-100 transition-all">
                                                <Icons.LogIn /> Yönetici Girişi
                                            </button>
                                        </>
                                    ) : (
                                        <button onClick={handleLogout} className="flex items-center gap-2 px-3 py-1.5 rounded-lg font-medium text-xs bg-red-50 text-red-600 hover:bg-red-100 transition-all">
                                            <Icons.LogOut /> Çıkış Yap
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {activeTab === 'calendar' && (
                        <div className="max-w-full mx-auto p-4 animate-in fade-in duration-300">
                            <div className="bg-white p-4 rounded-xl shadow-sm border mb-4 flex flex-wrap gap-4 justify-between items-center print:hidden relative">
                                <div className="flex items-center gap-2 bg-gray-50 px-2 py-1 rounded border">
                                    <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()-1))} className="p-1 hover:bg-gray-200 rounded"><Icons.ChevronLeft /></button>
                                    <span className="font-bold min-w-[120px] text-center">{monthNames[currentDate.getMonth()]} {currentDate.getFullYear()}</span>
                                    <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth()+1))} className="p-1 hover:bg-gray-200 rounded"><Icons.ChevronRight /></button>
                                </div>
                                
                                {userRole === 'admin' && (
                                    <div className="flex items-center gap-2 animate-in fade-in">
                                        <span className="font-bold text-gray-600">Tür:</span>
                                        <select value={selectedShiftType} onChange={(e) => setSelectedShiftType(e.target.value)} className="border p-1 rounded bg-white">
                                            {shiftTypes.map(t => (<option key={t} value={t}>{t === 'X' ? 'X (İstemiyor)' : t}</option>))}
                                        </select>
                                    </div>
                                )}

                                {userRole === 'doctor' && (
                                    <div className="flex items-center gap-2 animate-in fade-in">
                                        <span className="font-bold text-gray-600">Tercih:</span>
                                        <select value={selectedShiftType} onChange={(e) => setSelectedShiftType(e.target.value)} className="border p-1 rounded bg-white font-medium text-gray-700 focus:ring-2 focus:ring-blue-300 outline-none">
                                            {['X', 'Yİ', 'R'].map(t => (
                                                <option key={t} value={t}>
                                                    {t === 'X' ? 'X (İstemiyorum)' : t === 'Yİ' ? 'Yıllık İzin' : 'Rapor'}
                                                </option>
                                            ))}
                                        </select>
                                        <span className="text-xs text-gray-500 ml-2 hidden sm:inline">(Seçili durumu kutuya işlemek için tıklayın)</span>
                                    </div>
                                )}
                                
                                <div className="flex gap-2">
                                    {userRole === 'admin' && (
                                        <>
                                            <button onClick={() => {
                                                const newId = doctors.length > 0 ? Math.max(...doctors.map(d => d.id)) + 1 : 1;
                                                const newTc = Math.floor(Math.random() * 10000000000 + 10000000000).toString(); // Placeholder TC
                                                const newDocs = [...doctors, { id: newId, name: `Yeni Hekim ${newId}`, tc: newTc }];
                                                setDoctors(newDocs);
                                                saveToCloud({doctors: newDocs});
                                                showModal("Bilgi", `Yeni hekim eklendi. Geçici TC: ${newTc}.`, "info");
                                            }} className="bg-green-100 text-green-700 px-3 py-1 rounded flex items-center gap-1 hover:bg-green-200"><Icons.UserPlus /> Ekle</button>
                                            <button onClick={() => {if(confirm('BU AYIN tüm nöbetlerini silmek istediğinize emin misiniz?')) { setShifts({}); saveToCloud({shifts: {}}); }}} className="bg-red-100 text-red-700 px-3 py-1 rounded flex items-center gap-1 hover:bg-red-200"><Icons.Trash2 /> Temizle</button>
                                        </>
                                    )}
                                    
                                    {userRole === 'admin' && (
                                        <div className="relative">
                                            <button onClick={() => setPrintMenuOpen(!printMenuOpen)} className="bg-blue-600 text-white px-3 py-1 rounded flex items-center gap-1 hover:bg-blue-700"><Icons.Printer /> Yazdır</button>
                                            {printMenuOpen && (
                                                <div className="absolute right-0 top-full mt-2 w-40 bg-white shadow-xl rounded-lg border z-50 overflow-hidden">
                                                    <button onClick={exportToPDF} className="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2 text-gray-700"><Icons.Printer size={16}/> PDF (Yazdır)</button>
                                                    <button onClick={() => exportToJPEG('calendar')} className="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2 text-gray-700"><Icons.FileImage size={16}/> Resim (JPEG)</button>
                                                    <button onClick={() => exportToExcel('calendar')} className="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2 text-gray-700"><Icons.FileSpreadsheet size={16}/> Excel (.xlsx)</button>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div ref={tableRef} className="max-w-full overflow-x-auto bg-white shadow-lg rounded-xl border border-gray-200 print:shadow-none print:border-none print:overflow-visible">
                                <div className="hidden print:block text-center mb-6 mt-4">
                                    <h2 className="text-2xl font-bold">{monthNames[currentDate.getMonth()]} {currentDate.getFullYear()} - Hekim Nöbet Çizelgesi</h2>
                                </div>
                                <table className="w-full text-base border-collapse">
                                    <thead>
                                        <tr>
                                            <th className="sticky left-0 z-20 bg-gray-100 border-b-2 border-r-2 border-gray-300 p-3 min-w-[200px] text-left text-gray-700 font-bold shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">Hekim Adı / Günler</th>
                                            {days.map(day => {
                                                const status = checkDayStatus(day);
                                                return (
                                                    <th key={day} className={`border-b-2 border-r-2 border-gray-300 p-1 min-w-[34px] text-center ${status.isOff ? 'bg-gray-200 text-gray-800' : 'bg-gray-50 text-gray-600'}`}>
                                                        <div className="flex flex-col items-center justify-center h-full">
                                                            <span className="text-xs font-medium mb-1 opacity-70">{new Date(currentDate.getFullYear(), currentDate.getMonth(), day).toLocaleDateString('tr-TR', { weekday: 'short' }).slice(0,2)}</span>
                                                            <span className="font-bold text-lg">{day}</span>
                                                        </div>
                                                    </th>
                                                );
                                            })}
                                            <th className="sticky right-0 z-20 bg-gray-100 border-b-2 border-l-2 border-gray-300 p-2 min-w-[50px] text-center font-bold text-gray-700 text-xs">Toplam<br/>Nöbet</th>
                                            <th className="sticky right-0 z-20 bg-gray-100 border-b-2 border-l-2 border-gray-300 p-2 min-w-[50px] text-center font-bold text-gray-700 text-xs">Top.<br/>Saat</th>
                                            <th className="sticky right-0 z-20 bg-gray-100 border-b-2 border-l-2 border-gray-300 p-2 min-w-[50px] text-center font-bold text-gray-700 text-xs">Aylık<br/>Mesai</th>
                                            <th className="sticky right-0 z-20 bg-gray-100 border-b-2 border-l-2 border-gray-300 p-2 min-w-[50px] text-center font-bold text-gray-700 text-xs shadow-[-2px_0_5px_-2px_rgba(0,0,0,0.1)]">Ek<br/>Mesai</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {doctors.map((doctor, index) => {
                                            const stats = calculateDoctorStats(doctor.id);
                                            const isMe = userRole === 'doctor' && loggedInDoctorId === doctor.id;
                                            const canEdit = userRole === 'admin' || isMe;
                                            const rowClass = userRole === 'doctor' && !isMe ? 'opacity-50 grayscale bg-gray-50' : 'hover:bg-gray-50 transition-colors';

                                            return (
                                                <tr key={doctor.id} className={rowClass}>
                                                    <td className="sticky left-0 z-10 bg-white border-b-2 border-r-2 border-gray-300 p-2 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] group">
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-gray-400 text-xs w-4">{index + 1}</span>
                                                            {userRole === 'admin' ? (
                                                                <div className="flex flex-col flex-1">
                                                                    <input type="text" value={doctor.name} onChange={(e) => { const newDocs = [...doctors]; newDocs[index].name = e.target.value; setDoctors(newDocs); saveToCloud({doctors: newDocs}); }} className="w-full bg-transparent border-none outline-none focus:ring-1 focus:ring-blue-300 rounded px-1 font-medium text-gray-800 truncate" />
                                                                    <input type="text" value={doctor.tc || ''} placeholder="TCKN" onChange={(e) => { const newDocs = [...doctors]; newDocs[index].tc = e.target.value; setDoctors(newDocs); saveToCloud({doctors: newDocs}); }} className="w-full text-[10px] text-gray-400 bg-transparent border-none outline-none focus:ring-1 focus:ring-blue-300 rounded px-1" />
                                                                </div>
                                                            ) : (
                                                                <span className={`flex-1 px-1 font-medium truncate ${isMe ? 'text-blue-700 font-bold' : 'text-gray-800'}`}>{doctor.name}</span>
                                                            )}
                                                            {userRole === 'admin' && (
                                                                <button onClick={() => { if(confirm('Hekim silinsin mi?')) { const newDocs = doctors.filter(d => d.id !== doctor.id); setDoctors(newDocs); saveToCloud({doctors: newDocs}); }}} className="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 transition-all p-1 print:hidden"><Icons.X /></button>
                                                            )}
                                                        </div>
                                                    </td>
                                                    {days.map(day => {
                                                        const shiftValue = shifts[`${doctor.id}-${day}`];
                                                        const status = checkDayStatus(day);
                                                        const clickable = userRole === 'admin' || (userRole === 'doctor' && isMe);
                                                        return (
                                                            <td key={day} onClick={() => { if(clickable) handleCellClick(doctor.id, day); }} className={`border-b-2 border-r-2 border-gray-300 transition-all duration-200 relative group ${clickable ? 'cursor-pointer' : 'cursor-default'} ${status.isOff ? 'bg-gray-200 hover:bg-gray-300' : 'hover:bg-blue-50'} ${!clickable && !status.isOff ? 'bg-white' : ''}`}>
                                                                <div className="h-10 w-full flex items-center justify-center">
                                                                    {shiftValue && (<div className={getShiftStyle(shiftValue)}>{shiftValue}</div>)}
                                                                </div>
                                                            </td>
                                                        );
                                                    })}
                                                    <td className="sticky right-0 z-10 bg-gray-50 border-b-2 border-l-2 border-gray-200 p-2 text-center font-bold text-green-700">{stats.count24}</td>
                                                    <td className="sticky right-0 z-10 bg-gray-50 border-b-2 border-l-2 border-gray-200 p-2 text-center font-bold text-blue-700">{stats.totalWorkedHours}</td>
                                                    <td className="sticky right-0 z-10 bg-gray-50 border-b-2 border-l-2 border-gray-200 p-2 text-center text-gray-600 text-xs">{stats.personalTarget}</td>
                                                    <td className={`sticky right-0 z-10 bg-gray-50 border-b-2 border-l-2 border-gray-200 p-2 text-center font-bold shadow-[-2px_0_5px_-2px_rgba(0,0,0,0.1)] ${stats.extraHours < 0 ? 'text-red-600' : 'text-blue-600'}`}>{stats.extraHours}</td>
                                                </tr>
                                            );
                                        })}
                                        <tr>
                                            <td className="sticky left-0 z-10 bg-gray-50 border-b-2 border-r-2 border-gray-300 p-2 font-bold text-gray-700 text-right">Günlük:</td>
                                            {days.map(day => (<td key={`day-total-${day}`} className="border-b-2 border-r-2 border-gray-300 p-1 text-center font-bold text-gray-600 text-xs">{getDailyDoctorCount(day)}</td>))}
                                            <td className="sticky right-0 z-10 bg-gray-50 border-b-2 border-l-2 border-gray-200"></td><td className="sticky right-0 z-10 bg-gray-50 border-b-2 border-l-2 border-gray-200"></td><td className="sticky right-0 z-10 bg-gray-50 border-b-2 border-l-2 border-gray-200"></td><td className="sticky right-0 z-10 bg-gray-50 border-b-2 border-l-2 border-gray-200"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div className="mt-8 bg-white p-6 rounded-xl shadow-sm border border-yellow-100 print:hidden">
                                <h3 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                                    <span className="bg-yellow-100 text-yellow-600 p-2 rounded-lg"><Icons.MessageSquare size={20} /></span> 
                                    Nöbet & İzin İstekleri
                                </h3>

                                {userRole === 'doctor' && loggedInDoctorId && (
                                    <div className="space-y-3">
                                        <label className="block text-sm font-medium text-gray-700">
                                            Sayın {doctors.find(d => d.id === loggedInDoctorId)?.name}, bu ay için özel isteklerinizi buraya yazabilirsiniz:
                                        </label>
                                        <textarea
                                            value={doctorRequests[loggedInDoctorId] || ''}
                                            onChange={(e) => {
                                                const newReqs = {...doctorRequests, [loggedInDoctorId]: e.target.value};
                                                setDoctorRequests(newReqs);
                                                saveToCloud({requests: newReqs});
                                            }}
                                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-400 outline-none h-24 resize-none"
                                            placeholder="Örn: 15-20 arası yıllık izin kullanmak istiyorum..."
                                        />
                                        <div className="text-xs text-gray-500 text-right">Otomatik kaydedilir.</div>
                                    </div>
                                )}

                                {userRole === 'admin' && (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {doctors.map(doc => {
                                            const req = doctorRequests[doc.id];
                                            if (!req) return null;
                                            return (
                                                <div key={doc.id} className="bg-yellow-50 p-3 rounded-lg border border-yellow-200 relative group">
                                                    <div className="font-bold text-sm text-gray-800 mb-1">{doc.name}</div>
                                                    <p className="text-sm text-gray-600 italic">"{req}"</p>
                                                    <button 
                                                        onClick={() => {
                                                            if(confirm('Bu isteği silmek istediğinize emin misiniz?')) {
                                                                const newReqs = {...doctorRequests};
                                                                delete newReqs[doc.id];
                                                                setDoctorRequests(newReqs);
                                                                saveToCloud({requests: newReqs});
                                                            }
                                                        }}
                                                        className="absolute top-2 right-2 text-red-300 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity"
                                                        title="İsteği Sil"
                                                    >
                                                        <Icons.Trash2 size={14} />
                                                    </button>
                                                </div>
                                            )
                                        })}
                                        {Object.keys(doctorRequests).length === 0 && (
                                            <div className="col-span-full text-center text-gray-400 py-4 italic">Henüz talep bulunmuyor.</div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {activeTab === 'generator' && (
                        <div className="max-w-7xl mx-auto p-4 animate-in slide-in-from-right-4 duration-300">
                             <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div className="space-y-4">
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-blue-100 h-full"><div className="flex justify-between items-center mb-4"><h3 className="text-md font-bold text-gray-800 flex items-center gap-2"><div className="bg-blue-100 p-1.5 rounded text-blue-600"><Icons.BrainCircuit /></div> Kişisel Hedefler (Arz)</h3><div className="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600 font-medium">Toplam: <span className="text-blue-600 font-bold">{getTotalSupply()}</span></div></div><div className="max-h-[500px] overflow-y-auto pr-2 space-y-2"><div className="grid grid-cols-12 gap-2 text-[10px] font-bold text-gray-500 px-1 mb-1 items-center"><div className="col-span-4">Hekim (H.İçi/H.Sonu)</div><div className="col-span-4 flex justify-center items-center gap-1"><button onClick={() => changeAllTargets(-1)} className="w-4 h-4 bg-gray-200 rounded flex items-center justify-center text-[9px] hover:bg-gray-300">-</button><span>Hedef</span><button onClick={() => changeAllTargets(1)} className="w-4 h-4 bg-gray-200 rounded flex items-center justify-center text-[9px] hover:bg-gray-300">+</button></div><div className="col-span-4 flex justify-center items-center gap-1"><button onClick={() => changeAllGaps(-1)} className="w-4 h-4 bg-gray-200 rounded flex items-center justify-center text-[9px] hover:bg-gray-300">-</button><span>Boşluk</span><button onClick={() => changeAllGaps(1)} className="w-4 h-4 bg-gray-200 rounded flex items-center justify-center text-[9px] hover:bg-gray-300">+</button></div></div>{doctors.map(doc => { 
                                        const currentTarget = doctorTargets[doc.id] !== undefined ? doctorTargets[doc.id] : Math.ceil(getTotalDemand() / doctors.length); 
                                        const currentGap = doctorGaps[doc.id] !== undefined ? doctorGaps[doc.id] : 1; 
                                        let weekdayCount = 0; let weekendCount = 0;
                                        days.forEach(day => {
                                            if (shifts[`${doc.id}-${day}`] === '24') {
                                                const { isWeekend } = checkDayStatus(day);
                                                if (isWeekend) weekendCount++; else weekdayCount++;
                                            }
                                        });
                                        return (<div key={doc.id} className="grid grid-cols-12 gap-1 items-center bg-gray-50 p-2 rounded-lg border hover:bg-gray-100 transition-colors"><div className="col-span-4 flex flex-col"><span className="font-medium truncate text-xs">{doc.name}</span><span className="text-[9px] text-gray-500 font-mono flex gap-1">HI:<span className="text-blue-600 font-bold">{weekdayCount}</span> HS:<span className="text-orange-600 font-bold">{weekendCount}</span></span></div><div className="col-span-4 flex items-center justify-center gap-1"><button onClick={() => { const val = Math.max(0, currentTarget - 1); setDoctorTargets({...doctorTargets, [doc.id]: val}); saveToCloud({targets: {...doctorTargets, [doc.id]: val}}); }} className="w-5 h-5 bg-white border rounded hover:bg-red-50 text-red-600 font-bold">-</button><span className="w-6 text-center font-bold text-blue-700">{currentTarget}</span><button onClick={() => { const val = currentTarget + 1; setDoctorTargets({...doctorTargets, [doc.id]: val}); saveToCloud({targets: {...doctorTargets, [doc.id]: val}}); }} className="w-5 h-5 bg-white border rounded hover:bg-green-50 text-green-600 font-bold">+</button></div><div className="col-span-4 flex items-center justify-center gap-1"><button onClick={() => { const val = Math.max(0, currentGap - 1); setDoctorGaps({...doctorGaps, [doc.id]: val}); saveToCloud({gaps: {...doctorGaps, [doc.id]: val}}); }} className="w-5 h-5 bg-white border rounded hover:bg-gray-200">-</button><span className="w-6 text-center font-medium text-gray-700 text-xs">{currentGap}</span><button onClick={() => { const val = currentGap + 1; setDoctorGaps({...doctorGaps, [doc.id]: val}); saveToCloud({gaps: {...doctorGaps, [doc.id]: val}}); }} className="w-5 h-5 bg-white border rounded hover:bg-gray-200">+</button></div></div>); 
                                    })}</div></div>
                                </div>
                                <div className="space-y-4">
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-purple-100 h-full flex flex-col"><div className="flex justify-between items-center mb-4"><h3 className="text-md font-bold text-gray-800 flex items-center gap-2"><div className="bg-purple-100 p-1.5 rounded text-purple-600"><Icons.LayoutList /></div> Günlük İhtiyaç (Talep)</h3><div className="text-xs bg-gray-100 px-2 py-1 rounded text-gray-600 font-medium">Toplam: <span className="text-purple-600 font-bold">{getTotalDemand()}</span></div></div><div className="bg-purple-50 p-2 rounded text-[10px] text-purple-800 mb-2 border border-purple-200 flex justify-between items-center"><span>Tüm Günler:</span><div className="flex gap-1"><button onClick={() => changeAllDailyTargets(-1)} className="px-2 py-0.5 bg-white rounded border hover:bg-purple-100 font-bold">-</button><button onClick={() => changeAllDailyTargets(1)} className="px-2 py-0.5 bg-white rounded border hover:bg-purple-100 font-bold">+</button></div></div><div className="grid grid-cols-3 gap-2 overflow-y-auto pr-1 flex-1 content-start">{days.map(day => { const status = checkDayStatus(day); const target = dailyTargets[day] !== undefined ? dailyTargets[day] : 2; return (<div key={day} className={`flex flex-col items-center p-2 rounded border ${status.isOff ? 'bg-orange-50 border-orange-100' : 'bg-gray-50 border-gray-100'}`}><span className={`text-[10px] font-bold mb-1 ${status.isOff ? 'text-orange-600' : 'text-gray-500'}`}>{day} {monthNames[currentDate.getMonth()].slice(0,3)}</span><div className="flex items-center gap-1"><button onClick={() => { const val = Math.max(0, target - 1); setDailyTargets({...dailyTargets, [day]: val}); saveToCloud({dailyTargets: {...dailyTargets, [day]: val}}); }} className="w-5 h-5 bg-white border rounded hover:bg-gray-100">-</button><span className="font-bold text-gray-700 w-4 text-center">{target}</span><button onClick={() => { const val = target + 1; setDailyTargets({...dailyTargets, [day]: val}); saveToCloud({dailyTargets: {...dailyTargets, [day]: val}}); }} className="w-5 h-5 bg-white border rounded hover:bg-gray-100">+</button></div></div>) })}</div></div>
                                </div>
                                <div className="space-y-4">
                                    <div className="bg-white p-4 rounded-xl shadow-sm border border-orange-100">
                                        <h3 className="text-md font-bold text-gray-800 mb-3 flex items-center gap-2"><div className="bg-orange-100 p-1.5 rounded text-orange-600"><Icons.Users /></div> Birlikte Nöbet (Buddy)</h3>
                                        <div className="flex gap-2 mb-2 text-[10px] font-bold">
                                            <label className="flex items-center gap-1 cursor-pointer"><input type="radio" name="groupType" checked={groupType === 'strict'} onChange={() => setGroupType('strict')} /> Kesin (Hepsi)</label>
                                            <label className="flex items-center gap-1 cursor-pointer"><input type="radio" name="groupType" checked={groupType === 'partial'} onChange={() => setGroupType('partial')} /> Kısmi (En az 3)</label>
                                        </div>
                                        <div className="flex flex-wrap gap-1 mb-3 max-h-24 overflow-y-auto">{doctors.map(doc => (<button key={doc.id} onClick={() => toggleSelectForGroup(doc.id)} className={`px-2 py-1 text-[10px] rounded border transition-colors ${selectedForGroup.includes(doc.id) ? 'bg-orange-500 text-white border-orange-600' : 'bg-white hover:bg-gray-50'}`}>{doc.name}</button>))}</div>
                                        <button onClick={createGroup} disabled={selectedForGroup.length < 2} className="w-full py-1.5 bg-orange-500 text-white rounded-lg font-bold hover:bg-orange-600 disabled:opacity-50 mb-3 text-xs">GRUP OLUŞTUR</button>
                                        {pairedGroups.length > 0 && (
                                            <div className="space-y-1">
                                                <p className="text-[10px] font-bold text-gray-600">Gruplar:</p>
                                                {pairedGroups.map((group, idx) => (
                                                    <div key={idx} className="flex items-center justify-between bg-orange-50 border border-orange-200 p-1 rounded text-[10px]">
                                                        <div className="flex flex-col truncate w-full">
                                                            <span className="font-bold text-orange-700">{group.type === 'strict' ? '(Kesin)' : '(Kısmi)'}</span>
                                                            <span className="truncate">{group.ids.map(id => doctors.find(d => d.id === id)?.name).join(' & ')}</span>
                                                        </div>
                                                        <button onClick={() => removeGroup(idx)} className="text-red-500 hover:text-red-700 ml-1"><Icons.Trash2 size={12}/></button>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    <div className="bg-white p-4 rounded-xl shadow-lg border border-gray-200"><div className="flex justify-between text-xs mb-2"><span className="text-gray-500">Arz (Hekim Gücü):</span><span className="font-bold text-blue-600">{getTotalSupply()}</span></div><div className="flex justify-between text-xs mb-4"><span className="text-gray-500">Talep (Günlük İhtiyaç):</span><span className="font-bold text-purple-600">{getTotalDemand()}</span></div><button onClick={confirmGeneration} className="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold text-md rounded-lg shadow hover:opacity-90 transition-transform active:scale-95 flex items-center justify-center gap-2"><Icons.Sparkles /> DAĞITIMI BAŞLAT</button></div>
                                </div>
                            </div>
                        </div>
                    )}

                    {activeTab === 'lottery' && (
                        <div className="max-w-6xl mx-auto p-4 animate-in slide-in-from-bottom-4 duration-500">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div className="bg-white p-6 rounded-2xl shadow-lg border border-pink-100 flex flex-col h-full">
                                    <div className="flex items-center gap-3 mb-6">
                                        <div className="p-3 bg-pink-100 text-pink-600 rounded-xl"><Icons.Dices size={32} /></div>
                                        <div><h2 className="text-2xl font-bold text-gray-800">Kura Ayarları</h2><p className="text-sm text-gray-500">Adil ve şeffaf seçimler için</p></div>
                                    </div>
                                    <div className="space-y-6 flex-1">
                                        <div><label className="block text-sm font-bold text-gray-700 mb-2">Kura Başlığı</label><input type="text" value={lotteryTitle} onChange={(e) => setLotteryTitle(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 outline-none transition-all" placeholder="Örn: Bayram Nöbetçisi" /></div>
                                        <div>
                                            <div className="flex justify-between items-center mb-2"><label className="block text-sm font-bold text-gray-700">Katılımcı Havuzu</label><div className="text-xs space-x-2"><button onClick={() => setLotteryParticipants(doctors.map(d => d.id))} className="text-blue-600 hover:underline">Tümünü Seç</button><button onClick={() => setLotteryParticipants([])} className="text-red-600 hover:underline">Temizle</button></div></div>
                                            <div className="border border-gray-200 rounded-lg p-3 max-h-60 overflow-y-auto bg-gray-50">
                                                <div className="grid grid-cols-2 gap-2">
                                                    {doctors.map(doc => (
                                                        <label key={doc.id} className={`flex items-center gap-2 p-2 rounded cursor-pointer transition-all ${lotteryParticipants.includes(doc.id) ? 'bg-pink-50 border border-pink-200' : 'hover:bg-gray-100'}`}>
                                                            <input type="checkbox" checked={lotteryParticipants.includes(doc.id)} onChange={() => toggleLotteryParticipant(doc.id)} className="w-4 h-4 text-pink-600 rounded focus:ring-pink-500" />
                                                            <span className="text-sm text-gray-700 truncate">{doc.name}</span>
                                                        </label>
                                                    ))}
                                                </div>
                                            </div>
                                            <p className="text-xs text-right mt-1 text-gray-500">Seçili: <span className="font-bold text-pink-600">{lotteryParticipants.length}</span> kişi</p>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-2">Kaç Kişi Seçilecek?</label>
                                            <div className="flex items-center gap-4">
                                                <input type="range" min="1" max={Math.max(1, lotteryParticipants.length)} value={lotteryWinnerCount} onChange={(e) => setLotteryWinnerCount(parseInt(e.target.value))} className="w-full accent-pink-600" />
                                                <span className="text-2xl font-bold text-pink-600 w-12 text-center">{lotteryWinnerCount}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <button onClick={handleLotteryDraw} disabled={isDrawing || lotteryParticipants.length === 0} className={`w-full mt-6 py-4 rounded-xl font-bold text-lg text-white shadow-lg transition-all transform active:scale-95 flex items-center justify-center gap-3 ${isDrawing ? 'bg-gray-400 cursor-not-allowed' : 'bg-gradient-to-r from-pink-500 to-purple-600 hover:shadow-pink-200 hover:-translate-y-1'}`}>
                                        {isDrawing ? 'Çekiliyor...' : <><Icons.Dices /> KURA ÇEK</>}
                                    </button>
                                </div>
                                <div className="bg-gray-900 rounded-2xl shadow-2xl p-8 flex flex-col items-center justify-center text-center relative overflow-hidden min-h-[500px]">
                                    <div className="absolute top-4 right-4 z-20 flex flex-col gap-2">
                                        {!isRecording ? (
                                            <button onClick={startRecording} className="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-full text-xs font-bold transition-all animate-pulse">
                                                <Icons.Video size={14} /> Kaydı Başlat
                                            </button>
                                        ) : (
                                            <button onClick={stopRecording} className="flex items-center gap-2 bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-full text-xs font-bold transition-all">
                                                <Icons.StopCircle size={14} /> Kaydı Bitir
                                            </button>
                                        )}
                                        {recordedBlob && !isRecording && (
                                            <button onClick={shareVideoOnWhatsApp} className="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-full text-xs font-bold transition-all animate-in fade-in zoom-in">
                                                <Icons.Share size={14} /> WhatsApp ile Paylaş
                                            </button>
                                        )}
                                    </div>
                                    <div className="absolute top-0 left-0 w-full h-full opacity-20 pointer-events-none"><div className="absolute top-10 left-10 w-32 h-32 bg-purple-500 rounded-full blur-3xl"></div><div className="absolute bottom-10 right-10 w-40 h-40 bg-pink-500 rounded-full blur-3xl"></div></div>
                                    {isDrawing ? (
                                        <div className="animate-bounce-slow">
                                            <div className="text-9xl mb-8 animate-spin" style={{ animationDuration: '3s' }}>🎲</div>
                                            <h3 className="text-3xl font-bold text-white mb-2">Kura Çekiliyor...</h3>
                                            <p className="text-gray-400">Şans kime gülecek?</p>
                                        </div>
                                    ) : lotteryResults ? (
                                        <div className="animate-in zoom-in duration-500 w-full z-10">
                                            <div className="text-yellow-400 mb-6 flex justify-center"><Icons.Sparkles /> <Icons.Sparkles /> <Icons.Sparkles /></div>
                                            <h2 className="text-2xl text-gray-300 mb-2 uppercase tracking-widest">{lotteryTitle}</h2>
                                            <h1 className="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500 mb-8">KAZANANLAR</h1>
                                            <div className="space-y-4 max-h-[300px] overflow-y-auto w-full px-4 custom-scroll">
                                                {lotteryResults.map((winner, idx) => (
                                                    <div key={idx} className="bg-white/10 backdrop-blur-md border border-white/20 p-4 rounded-xl flex items-center justify-between animate-in slide-in-from-bottom-2" style={{ animationDelay: `${idx * 150}ms` }}>
                                                        <div className="flex items-center gap-4">
                                                            <div className="bg-gradient-to-br from-yellow-400 to-orange-600 w-10 h-10 rounded-full flex items-center justify-center text-white font-bold shadow-lg">{idx + 1}</div>
                                                            <span className="text-xl font-bold text-white text-left">{winner.name}</span>
                                                        </div>
                                                        <span className="text-yellow-400">👑</span>
                                                    </div>
                                                ))}
                                            </div>
                                            <button onClick={() => setLotteryResults(null)} className="mt-8 text-gray-400 hover:text-white text-sm underline">Yeni Kura</button>
                                        </div>
                                    ) : (
                                        <div className="text-gray-500">
                                            <div className="text-6xl mb-4 opacity-30">🎰</div>
                                            <p className="text-xl">Sonuçlar burada görünecek</p>
                                            <p className="text-sm mt-2 opacity-50">Sol taraftan ayarları yapıp butona basın.</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {activeTab === 'bluecode' && (
                        <div className="blue-code-wrapper">
                            <div ref={blueCodeRef} className="bg-white shadow-lg blue-code-container" style={{ width: '210mm', minHeight: '297mm', padding: '20mm', margin: '0 auto', display: 'flex', flexDirection: 'column' }}>
                                <div className="flex justify-between items-end border-2 border-black p-2 mb-0">
                                    <div className="font-bold text-lg w-1/4 text-center self-center uppercase">{monthNames[currentDate.getMonth()]}</div>
                                    <div className="font-bold text-xl text-center flex-1 border-l-2 border-black pl-2">AYVACIK DEVLET HASTANESİ {currentDate.getFullYear()} YILI MAVİ KOD LİSTESİ</div>
                                </div>
                                <div className="overflow-x-auto flex-1">
                                    <table className="w-full border-collapse border-2 border-t-0 border-black text-sm">
                                        <thead><tr className="bg-white"><th className="border border-black p-2 w-32 text-center">TARİH</th><th className="border border-black p-2 w-32 text-center">GÜN</th><th className="border border-black p-2 text-center">NÖBETÇİ (09:00-09:00)</th></tr></thead>
                                        <tbody>
                                            {blueCodeList.map((item, idx) => (
                                                <tr key={idx} className={item.isWeekend ? "bg-gray-200" : "bg-white"}>
                                                    <td className="border border-black p-2 font-bold text-center">{item.date}</td>
                                                    <td className="border border-black p-2 text-center">{item.dayName}</td>
                                                    <td className="border border-black p-2 font-bold uppercase text-center">{item.doctor || "-"}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                <div className="mt-auto pt-8 flex justify-between px-16 text-center">
                                    <div><div className="font-bold mb-8">HAZIRLAYAN</div><div className="mb-1 font-bold">DR. MERT YAYLACI</div><div className="font-medium text-sm">Acil Sorumlu Hekimi</div></div>
                                    <div><div className="font-bold mb-8">ONAYLAYAN</div><div className="mb-1 font-bold">DR. EREN ELİBOL</div><div className="font-medium text-sm">Başhekim</div></div>
                                </div>
                                <div className="mt-8 text-center print:hidden flex justify-center gap-2 pb-8">
                                    <button onClick={exportToPDF} className="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700 flex items-center gap-2"><Icons.Printer /> PDF / Yazdır</button>
                                    <div className="relative">
                                        <button onClick={() => setPrintMenuOpen(!printMenuOpen)} className="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 flex items-center gap-2"><Icons.Download /> İndir</button>
                                        {printMenuOpen && (
                                            <div className="absolute left-0 bottom-full mb-2 w-40 bg-white shadow-xl rounded-lg border z-50 overflow-hidden">
                                                <button onClick={() => exportToJPEG('bluecode')} className="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2 text-gray-700"><Icons.FileImage size={16}/> Resim (JPEG)</button>
                                                <button onClick={() => exportToExcel('bluecode')} className="w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center gap-2 text-gray-700"><Icons.FileSpreadsheet size={16}/> Excel (.xlsx)</button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<NobetCizelgesi />);
    </script>
</body>
</html>
